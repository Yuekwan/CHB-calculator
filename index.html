<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chronic Hepatitis B – Fibrosis Calculator (APRI/ FIB-4)</title>

<style>
  body { font-family: Arial, sans-serif; max-width: 820px; margin: 30px auto; line-height: 1.6; }
  h2 { color: #2c3e50; margin-bottom: 8px; }

  label { display:block; margin-top: 12px; font-weight: bold; }
  input { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; }
  button { margin-top: 18px; padding: 12px; width: 100%; font-size: 16px; cursor:pointer; }

  .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } }

  .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-top: 16px; }
  .title { font-weight: bold; margin-bottom: 8px; }

  .bannerStop { border: 1px solid #b00020; background:#ffe9ec; color:#7a0014; padding:10px; border-radius:8px; font-weight:bold; }
  .bannerWarn { border: 1px solid #9a6a00; background:#fff6df; color:#6a4600; padding:10px; border-radius:8px; font-weight:bold; margin-top:10px; }

  .pill { display:inline-block; padding:4px 8px; border-radius: 999px; font-size: 13px; font-weight: bold; }
  .g { background:#e9f7ec; border:1px solid #1b5e20; color:#134718; }
  .a { background:#fff6df; border:1px solid #9a6a00; color:#6a4600; }
  .r { background:#ffe9ec; border:1px solid #b00020; color:#7a0014; }
  .n { background:#f2f2f2; border:1px solid #999; color:#333; }

  .row { margin-top: 6px; }
  .kv { display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
  .kv b { min-width: 90px; }

  .small { font-size: 0.92em; color:#555; margin-top: 12px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  /* Compact cut-off tables */
  .cutbox { font-size: 0.85em; line-height: 1.3; }
  table { border-collapse: collapse; width: 100%; margin-top: 8px; }
  th, td { border: 1px solid #ddd; padding: 6px; vertical-align: top; }
  th { background: #f7f7f7; text-align: left; }

  /* Color fill cells */
  .bg-g { background:#e9f7ec; color:#134718; }
  .bg-a { background:#fff6df; color:#6a4600; }
  .bg-r { background:#ffe9ec; color:#7a0014; }
  .toolcell { font-weight:bold; width: 12%; background:#f7f7f7; }

  /* Smaller references */
  .refbox { font-size: 0.78em; line-height: 1.3; color:#444; }
  .refbox ol { margin: 6px 0 0 18px; }

/* Button row */
.btn-row {
  display: flex;
  gap: 10px;
  max-width: 420px;   /* shorter bar */
  margin-top: 18px;
}

.btn-calc {
  flex: 3;            /* larger button */
}

.btn-reset {
  flex: 1;            /* smaller button */
  background: #f2f2f2;
  border: 1px solid #bbb;
  color: #333;
}

/* Mobile fallback */
@media (max-width: 480px) {
  .btn-row {
    flex-direction: column;
    max-width: 100%;
  }
}
</style>
</head>

<body>

<h2>Chronic Hepatitis B – Fibrosis Calculator (APRI/ FIB-4)</h2>

<div class="grid">
  <div>
    <label>Age (years)</label>
    <input id="age" type="number" min="1">
  </div>

  <div>
    <label>Platelet (×10⁹/L)</label>
    <input id="plt" type="number" min="1">
  </div>

  <div>
    <label>AST (U/L)</label>
    <input id="ast" type="number" min="1">
  </div>

  <div>
    <label>ALT (U/L)</label>
    <input id="alt" type="number" min="1">
  </div>

  <div>
    <label>AST ULN (U/L)</label>
    <input id="uln_ast" type="number" min="1" value="40">
  </div>
</div>

<div class="btn-row">
  <button class="btn-calc" onclick="calculate()">Calculate</button>
  <button class="btn-reset" onclick="resetForm()">Reset</button>
</div>

<div id="flags"></div>

<div id="apriCard" class="card"></div>
<div id="fib4Card" class="card"></div>

<p class="small">
Formulas used:<br>
<span class="mono">APRI = (AST / ULN_AST × 100) / Platelet</span><br>
<span class="mono">FIB-4 = (Age × AST) / (Platelet × √ALT)</span>
</p>

<div class="card cutbox">
  <div class="title">Cut-offs used</div>

  <table>
    <tr>
      <th style="width:12%;">Tool</th>
      <th style="width:18%;">Score</th>
      <th style="width:34%;">Category</th>
      <th>Management</th>
    </tr>

    <tr>
      <td class="toolcell" rowspan="3">APRI</td>
      <td class="bg-g">≤ 0.5</td>
      <td class="bg-g">Rule out significant fibrosis (F0–F1)</td>
      <td class="bg-g">Routine monitoring.</td>
    </tr>
    <tr>
      <td class="bg-a">&gt; 0.5 to ≤ 1.0</td>
      <td class="bg-a">Possible significant fibrosis (≥ F2)</td>
      <td class="bg-a">Repeat test to confirm persistent elevation or consider transient elastography.</td>
    </tr>
    <tr>
      <td class="bg-r">&gt; 1.0</td>
      <td class="bg-r">Possible cirrhosis (F4)</td>
      <td class="bg-r">Warrant transient elastography and refer hepatology.</td>
    </tr>

    <tr>
      <td class="toolcell" rowspan="3">FIB-4</td>
      <td class="bg-g">&lt; 1.45</td>
      <td class="bg-g">Low risk – rule out advanced fibrosis (<span style="white-space:nowrap;">&lt;F3</span>)
</td>
      <td class="bg-g">Routine monitoring.</td>
    </tr>
    <tr>
      <td class="bg-a">≥ 1.45 to &lt; 3.25</td>
      <td class="bg-a">Possible advanced fibrosis (≥ F3)</td>
      <td class="bg-a">Repeat test to confirm persistent elevation or consider transient elastography.</td>
    </tr>
    <tr>
      <td class="bg-r">≥ 3.25</td>
      <td class="bg-r">Advanced fibrosis / cirrhosis likely (F3–F4)</td>
      <td class="bg-r">Warrant transient elastography and refer hepatology.</td>
    </tr>
  </table>
</div>

<div class="card refbox">
  <div class="title">References</div>
  <ol>
    <li>World Health Organization. <i>Guidelines for the prevention, diagnosis, care and treatment for chronic hepatitis B infection</i>. Geneva: World Health Organization; 2024.</li>
    <li>Viral Hepatitis Control Office, Department of Health, Hong Kong SAR Government. <i>Management of adult patients with chronic hepatitis B in primary care (full guidance)</i>. Hong Kong: Department of Health; 2023.</li>
    <li>Liguori A, Zoncap M, Casazza G, Easterbrook P, Tsochatzis EA. Staging liver fibrosis and cirrhosis using non-invasive tests in people with chronic hepatitis B to inform WHO 2024 guidelines: a systematic review and meta-analysis. <i>Lancet Gastroenterol Hepatol</i>. 2025;10(4):332–349.</li>
  </ol>
</div>

<div class="disclaimer">
  <b>Disclaimer:</b> Educational / clinical decision support aid; does not replace clinical judgement or local referral criteria.
</div>

<script>
function numOrNull(v) {
  if (v === "" || v === null || v === undefined) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function isInvalid(n) { return n !== null && (Number.isNaN(n) || n <= 0); }
function pillClass(level) { return level; }

function resetForm() {
  // clear inputs
  ["age","plt","ast","alt","uln_ast"].forEach(id => {
    document.getElementById(id).value = "";
  });

  // restore default ULN
  document.getElementById("uln_ast").value = 40;

  // clear outputs
  document.getElementById("flags").innerHTML = "";
  document.getElementById("apriCard").innerHTML = "";
  document.getElementById("fib4Card").innerHTML = "";
}
function calculate() {
  const age = numOrNull(document.getElementById("age").value);
  const plt = numOrNull(document.getElementById("plt").value);
  const ast = numOrNull(document.getElementById("ast").value);
  const alt = numOrNull(document.getElementById("alt").value);
  const ulnAst = numOrNull(document.getElementById("uln_ast").value);

  let stopFlags = [];
  let warnFlags = [];

  // invalid input (stop) — any provided field <=0
  const fields = [["Age", age], ["Platelet", plt], ["AST", ast], ["ALT", alt], ["AST ULN", ulnAst]];
  fields.forEach(([name, val]) => { if (isInvalid(val)) stopFlags.push(`Invalid input: ${name} must be > 0.`); });

  // Platelet unit/entry likely wrong (WARN only)
  if (plt !== null && plt > 2000) {
    warnFlags.push("Platelet value is unusually high for ×10⁹/L. Possible unit error (e.g. entered /µL). Please verify.");
  }

  // Platelet thresholds (stop/warn)
  if (plt !== null) {
    if (plt < 50) stopFlags.push("Platelet <50 ×10⁹/L: scores may be unreliable/unstable → do not interpret.");
    else if (plt < 100) warnFlags.push("Platelet 50–100 ×10⁹/L: scores may be inflated; confirm with elastography.");
  }

  // AST ≥5×ULN_AST warn
  if (ast !== null && ulnAst !== null) {
    if (ast >= 5 * ulnAst) warnFlags.push("AST ≥5×ULN_AST: possible acute injury or non-hepatic source; interpret carefully.");
  }

  // ALT ≥200 warn
  if (alt !== null) {
    if (alt >= 200) warnFlags.push("ALT ≥200 U/L: possible acute hepatitis/flare; consider repeating when stable.");
  }

  // Age <35 warn
  if (age !== null && age < 35) warnFlags.push("FIB-4 not validated for age <35 years (may underestimate fibrosis).");

  // ULN_AST >40 warn
  if (ulnAst !== null && ulnAst > 40) warnFlags.push("APRI not well validated when AST ULN >40 U/L (lab-specific ULN variation).");

// AST:ALT ≥2 warn
if (ast !== null && alt !== null && alt > 0 && ast / alt >= 2)
  warnFlags.push("AST:ALT ≥2; fibrosis scores may be unreliable—interpret with caution.");

  // Render flags banner: show NOTHING if no flags
  const flagsEl = document.getElementById("flags");
  if (stopFlags.length) {
    flagsEl.innerHTML = `
      <div class="bannerStop">DO NOT INTERPRET (Stop flags)</div>
      <div class="bannerStop" style="margin-top:8px;">
        ${stopFlags.map(x => "• " + x).join("<br>")}
      </div>
      ${warnFlags.length ? `<div class="bannerWarn">${warnFlags.map(x => "• " + x).join("<br>")}</div>` : ""}
    `;
  } else if (warnFlags.length) {
    flagsEl.innerHTML = `
      <div class="bannerWarn">Warnings</div>
      <div class="bannerWarn" style="margin-top:8px;">
        ${warnFlags.map(x => "• " + x).join("<br>")}
      </div>
    `;
  } else {
    flagsEl.innerHTML = "";
  }

  // Partial calculations allowed unless stop flags
  const canAPRI = (ast !== null && ulnAst !== null && plt !== null) && !stopFlags.length;
  const canFIB4 = (age !== null && ast !== null && alt !== null && plt !== null) && !stopFlags.length;

  // APRI card
  let apriHtml = `<div class="title">APRI</div>`;
  if (!canAPRI) {
    let missing = [];
    if (ast === null) missing.push("AST");
    if (ulnAst === null) missing.push("AST ULN");
    if (plt === null) missing.push("Platelet");
    apriHtml += `
      <div class="row"><span class="pill n">Not calculated</span></div>
      <div class="row small">Missing for APRI: <b>${missing.join(", ") || "—"}</b></div>
    `;
  } else {
    const apri = ((ast / ulnAst) * 100) / plt;

    let level = "g", stage = "", mx = "";
    if (apri <= 0.5) {
      level = "g"; stage = "Rule out significant fibrosis (F0–F1)"; mx = "Routine monitoring.";
    } else if (apri <= 1.0) {
      level = "a"; stage = "Possible significant fibrosis (≥ F2)";
      mx = "Repeat test to confirm persistent elevation or consider transient elastography.";
    } else {
      level = "r"; stage = "Possible cirrhosis (F4)";
      mx = "Warrant transient elastography and refer hepatology.";
    }

    apriHtml += `
      <div class="kv">
        <b>Score</b> <span class="pill ${pillClass(level)}">${apri.toFixed(2)}</span>
      </div>
      <div class="kv row">
        <b>Stage</b> <span class="pill ${pillClass(level)}">${stage}</span>
      </div>
      <div class="kv row">
        <b>Mx</b> <span class="pill ${pillClass(level)}">${mx}</span>
      </div>
    `;
    window.__apriValue = apri;
  }
  document.getElementById("apriCard").innerHTML = apriHtml;

  // FIB-4 card
  let fib4Html = `<div class="title">FIB-4</div>`;
  if (!canFIB4) {
    let missing = [];
    if (age === null) missing.push("Age");
    if (ast === null) missing.push("AST");
    if (alt === null) missing.push("ALT");
    if (plt === null) missing.push("Platelet");
    fib4Html += `
      <div class="row"><span class="pill n">Not calculated</span></div>
      <div class="row small">Missing for FIB-4: <b>${missing.join(", ") || "—"}</b></div>
    `;
  } else {
    const fib4 = (age * ast) / (plt * Math.sqrt(alt));

    let level = "g", stage = "", mx = "";
    if (fib4 < 1.45) {
      level = "g"; stage = "Low risk – rule out advanced fibrosis (&lt;F3)"; mx = "Routine monitoring.";
    } else if (fib4 < 3.25) {
      level = "a"; stage = "Possible advanced fibrosis (≥ F3)";
      mx = "Repeat test to confirm persistent elevation or consider transient elastography.";
    } else {
      level = "r"; stage = "Advanced fibrosis / cirrhosis likely (F3–F4)";
      mx = "Warrant transient elastography and refer hepatology.";
    }

    fib4Html += `
      <div class="kv">
        <b>Score</b> <span class="pill ${pillClass(level)}">${fib4.toFixed(2)}</span>
      </div>
      <div class="kv row">
        <b>Stage</b> <span class="pill ${pillClass(level)}">${stage}</span>
      </div>
      <div class="kv row">
        <b>Mx</b> <span class="pill ${pillClass(level)}">${mx}</span>
      </div>
    `;
    window.__fib4Value = fib4;
  }
  document.getElementById("fib4Card").innerHTML = fib4Html;

  // Discordant scores (warn) — strict rules unchanged
  if (!stopFlags.length && canAPRI && canFIB4) {
    const apri = window.__apriValue;
    const fib4 = window.__fib4Value;
    const discordA = (apri <= 0.5 && fib4 >= 3.25);
    const discordB = (apri > 1.0 && fib4 < 1.45);

    if (discordA || discordB) {
      const existing = flagsEl.innerHTML;
      const msg = "⚠ Discordant scores: APRI and FIB-4 suggest different risk categories → consider transient elastography.";
      if (existing.includes("Warnings") || existing.includes("DO NOT INTERPRET")) {
        flagsEl.innerHTML = existing + `<div class="bannerWarn">${msg}</div>`;
      } else {
        flagsEl.innerHTML = `<div class="bannerWarn">Warnings</div><div class="bannerWarn" style="margin-top:8px;">• ${msg}</div>`;
      }
    }
  }
}
</script>

</body>
</html>